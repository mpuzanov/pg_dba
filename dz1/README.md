# Домашнее задание 1

## Работа с уровнями изоляции транзакции в PostgreSQL

Цель:  
научиться работать с Google Cloud Platform на уровне Google Compute Engine (IaaS)
научиться управлять уровнем изоляции транзакции в PostgreSQL и понимать особенность работы уровней *read commited* и *repeatable read*

### Описание/Пошаговая инструкция выполнения домашнего задания

создать новый проект в Google Cloud Platform, Яндекс облако или на любых ВМ, докере
далее создать инстанс виртуальной машины с дефолтными параметрами
добавить свой ssh ключ в metadata ВМ
зайти удаленным ssh (первая сессия), не забывайте про ssh-add
поставить PostgreSQL
>запустил PostgreSQL в докере

зайти вторым ssh (вторая сессия)
>так как я использовал докер то ssh не использовал

запустить везде `psql` из под пользователя postgres
> создал 2 сессии и выполнил команду - `docker exec -it database-server psql -U postgres -d db1 -W`

выключить `auto commit`
> выполнил в двух сессиях `\set AUTOCOMMIT off`

сделать в первой сессии новую таблицу и наполнить ее данными

```SQL
create table persons(id serial, first_name text, second_name text); 
insert into persons(first_name, second_name) values('ivan', 'ivanov'); 
insert into persons(first_name, second_name) values('petr', 'petrov'); 
commit;
```

>добавил таблицу через файл docker-compose

посмотреть текущий уровень изоляции: `show transaction isolation level;`
>получил `read committed`

начать новую транзакцию в обоих сессиях с дефолтным (не меняя) уровнем изоляции
в первой сессии добавить новую запись
`insert into persons(first_name, second_name) values('sergey', 'sergeev');`

сделать `select * from persons;` во второй сессии
видите ли вы новую запись и если да то почему?
> запись не вижу, потому что уровень транзакции `read committed` не допускает чтение незавершённых транзакций.

завершить первую транзакцию - `commit;`
сделать `select * from persons;` во второй сессии
видите ли вы новую запись и если да то почему?
> запись появилась, потому что транзакцию в первой сессии завершили.

завершите транзакцию во второй сессии
> завершил - `commit;`

начать новые но уже `repeatable read` транзакции - `set transaction isolation level repeatable read;`  
В первой сессии добавить новую запись
`insert into persons(first_name, second_name) values('sveta', 'svetova');`
сделать  `select * from persons;` во второй сессии
видите ли вы новую запись и если да то почему?
> записи нет, потому что уровень транзакции так же не позволяет видеть незавершённые транзакции

завершить первую транзакцию - `commit;`
сделать `select * from persons;` во второй сессии
видите ли вы новую запись и если да то почему?
> запись не появилась, потому что на этом уровне изоляции транзакция будет видеть одни и те же данные на протяжении всего срока ее действия, даже если другие транзакции внесут изменения в данные.

завершить вторую транзакцию
сделать `select * from persons;` во второй сессии
видите ли вы новую запись и если да то почему?
> запись появилась, потому что транзакцию во второй сессии завершили с уровнем изоляции `repeatable read`, теперь можно считать результат других завершённых транзакций прошедших за время открытой во 2 сессии.

ДЗ сдаем в виде миниотчета в markdown в гите

|Уровень изоляции транзакции | 1 сессия | 2 сессия |
| --- | --- | --- |
|read committed     | открыли транзакцию| не виден результат |
|read committed     | закрыли транзакцию| виден результат даже с открытой транзакцией во 2 сессии |
|repeatable read    | открыли транзакцию| не виден результат |
|repeatable read    | закрыли транзакцию| виден результат только с закрытой транзакцией во 2 сессии |
