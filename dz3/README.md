# ДЗ: Установка и настройка PostgreSQL

Установка и настройка PostgreSQL

**Цель:**  
создавать дополнительный диск для уже существующей виртуальной машины, размечать его и делать на нем файловую систему
переносить содержимое базы данных PostgreSQL на дополнительный диск
переносить содержимое БД PostgreSQL между виртуальными машинами

Описание/Пошаговая инструкция выполнения домашнего задания:  
создайте виртуальную машину c Ubuntu 20.04/22.04 LTS в GCE/ЯО/Virtual Box/докере  
> создал ВМ в ЯО  
 
поставьте на нее PostgreSQL 15 через sudo apt  
> установил  

проверьте что кластер запущен через `sudo -u postgres pg_lsclusters`  
>запущен  
>15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log

зайдите из под пользователя postgres в psql и сделайте произвольную таблицу с произвольным содержимым `create table test(c1 text);insert into test values('1');`  
> выполнил

остановите postgres например через `sudo -u postgres pg_ctlcluster 15 main stop`  
> остановил

создайте новый диск к ВМ размером 10GB
> создал  
> yc compute disk create --name first-disk --size 10 --description "disk for postgres"

добавьте свеже-созданный диск к виртуальной машине - надо зайти в режим ее редактирования и дальше выбрать пункт attach existing disk
> добавил  
> yc compute instance attach-disk vm-ubuntu --disk-name first-disk --mode rw

проинициализируйте диск согласно инструкции и подмонтировать файловую систему, только не забывайте менять имя диска на актуальное, в вашем случае это скорее всего будет /dev/sdb - https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux
перезагрузите инстанс и убедитесь, что диск остается примонтированным (если не так смотрим в сторону fstab)  
> выполнил согласно ссылки (использовал команды в файле command.md из текущего каталога)

сделайте пользователя postgres владельцем /mnt/data - `chown -R postgres:postgres /mnt/data/`
> выполнил используя sudo

перенесите содержимое /var/lib/postgres/15 в /mnt/data - `mv /var/lib/postgresql/15 /mnt/data`
> выполнил используя sudo

попытайтесь запустить кластер - `sudo -u postgres pg_ctlcluster 15 main start`
напишите получилось или нет и почему
> получил ошибку  
> Error: /var/lib/postgresql/15/main is not accessible or does not exist  
> в конфиг.файле задан каталог расположения данных, а мы его поменяли  

задание: найти конфигурационный параметр в файлах расположенных в `/etc/postgresql/15/main` который надо поменять и поменяйте его
напишите что и почему поменяли

```bash
выполнил замену переменной data_directory в файле postgresql.conf

> sudo nano /etc/postgresql/15/main/postgresql.conf
#data_directory = '/var/lib/postgresql/15/main'
data_directory = '/mnt/data/15/main'
```

попытайтесь запустить кластер - `sudo -u postgres pg_ctlcluster 15 main start`
напишите получилось или нет и почему
> кластер запустился так как стал известен путь к каталогу с данными

зайдите через через psql и проверьте содержимое ранее созданной таблицы
> созданная ранее таблица test с данными на месте

задание со звездочкой *: не удаляя существующий инстанс ВМ сделайте новый, поставьте на его PostgreSQL, удалите файлы с данными из `/var/lib/postgresql`, перемонтируйте внешний диск который сделали ранее от первой виртуальной машины ко второй и запустите PostgreSQL на второй машине так чтобы он работал с данными на внешнем диске, расскажите как вы это сделали и что в итоге получилось.

```
проделал необходимое задание.
выполненные команды в файле command.md в разделе со звёздочкой.

Здесь надо было отключить внешний диск от первой ВМ, иначе он не монтируется к другой ВМ.
А так аналогично выполненному ранее заданию: монтируем внешний диск, меняем конф.файл postgresql.conf, перезапускаем кластер PostgreSQL на ВМ2

в результате данные на месте.
```
